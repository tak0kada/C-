<a name="top"></a>
* [12月3日](#1203)
* [12月17日](#1217)

# <a name="1203"></a>2015/12/3 [↑](#top)
* 今日したこと: 個々のプロジェクトの課題の確認、OpenCVを使った細胞トラッキングの検討
* TODO(岡田): vagrantで動くイメージを作って配布すること

## セグメンテーション関連
細胞があるかどうかはセグメンテーションを利用することが多い。調べた範囲で分類すると
* 閾値設定して白黒にする
* 特徴検出(角とか画像の特徴を利用)
* 形態フィルタリング(孤立点の除去，不連続な点の接続と穴埋め)
* region accumulation(領域をつないだり)
* deformable model fitting(何か形の変化のモデルを使う)
* その他

になるらしい

* その他にはconvolutional neural network(CNN)とかいうdeep learningの1種とかが最近流行っぽい
* 微分を使ったモデルはdeformable..に含まれるらしく、ゲーム制作のアルゴリズムが流用できるらしくそれも有望

githubに挙げられていた論文は全体をボクセルに分割して(セグメンテーションに対応)からオプティカルフローを利用する感じだと思う。
どれで結果が出てもいいのだがたぶんどれも大雑把には同じだろうということで、まずはopencvを利用してデータを眺めて仮説を立てておきたい。

## トラッキング
* <http://d.hatena.ne.jp/shu223/20150518/1431901401>のトラッキングライブラリを使うのはどうか
* <http://docs.opencv.org/3.0-last-rst/modules/tracking/doc/tracking.html>を読む
* 実装はopencv_contribの中にあり、<https://github.com/Itseez/opencv_contrib/tree/master/modules/tracking>を参照する 
* ドキュメンテーションがまだ充実していないので自力でコードを読んで実装する必要がある。初心者には厳しそう。

* Haar分類器も使えるかも。ただし誰かが細胞で学習させたデータを発見する必要あり。<http://qiita.com/shu223/items/ffd2202eaf92d342f83d>



# <a name="1217"></a>2015/12/17 [↑](#top)
* プロジェクトの進捗状況を共有する会とした
* 今回で今年度は終了
* 顕微鏡で撮影したnd2ファイルからのデータ処理フローを作りたい

# 村田さん
* nd2 → tiff → rawの流れで画像ファイルを変換する。rawファイルにメタ情報を加えたものをmhdファイル(形式)と呼ぶ。
* MITKへのプラグインに組み込むべきこと
  * セグメンテーション 
  * メッシュ化 
  * 微分幾何
  * 要するに統計的な処理で他のパートで動かないものはここにねじ込む

## 疑問点
* 単一の細胞をトラッキングするのか、複数の細胞をトラッキングするのか？（これは我々の頑張り次第か？)  
→ 複数の細胞をトラッキングする
* トラッキングはNIS-Elementで行うのか？トラッキングを行った後でrawファイルにするのか？  
→ NIS-ELEMENTSの一番よいところは、生の画像だと「暗い」ところを、「見えやすい」ようにシグナル強度の非線形補正をしてくれる機能があるのです。NIS-ELEMENTSでのデフォルトで見たときの様子がそれ。
この「見えている様子」を反映した補正済みシグナル強度の画像とすれば、それ以降はすべてITK/VTKで行けるかもしれません。
が、もし、NISの方で使える機能があってそれを４D画像データとして出せるなら、その方が楽だろうなと思っています。村田さんがその２値化保存までは行けそうだ、と言っていました。<https://github.com/statgenetJimu/ShapeMove/blob/master/NIS-Element%20manual>  
→ それ以外のNISにあると言う噂のよさそうな機能は「手振れ防止機能」。背景画像は動いていないものとして座標補正してくれるらしいです。これについてはカメラ屋さんが持っているノウハウを使うのがよいと思います。

# 岩崎さん
* MITKに関しては
  * まず、実際の処理を行う部分はblankにしておいて、四次元データの読み込み＆出力ができるテンプレートを作ってしまう
  * blankの中に、例えばピクセルの数を数えるなどの簡単な処理を行うクラスを入れてみて、動くことを確認
  * その上で、岡田がやっている微分幾何などを実装したクラスを入れ込む。

## 疑問点
* itkやvtkだけではダメか 
* itkは三次元までしかできない(？)
* mitkはそれを四次元に拡張してGUIメイン、大きすげて手強い感が否めない
  * GUIがあるのは心強いかな・・・ （視覚化は必須）  
  → ITKは任意次元です。オブジェクト的には。ただし、画像ファイル入力的には、素のITKだと３次元まで。MITKは４次元完全対応なので、４(以上)次元の画像ファイル入力はMITKのオブジェクトを使うのがよいと思っています。
* セグメンテーションとトラッキングを、NIS-Elementで行うかMITKのプラグインに組み込むのか(上と共通)

# 岡田
* 細胞一つを球体にする
* あるいは、トラッキングがうまく行った場合、細胞一つ一つをノードと捉えて考察を加えることも可能?
  → 複数の細胞を考える

# これからの課題
## セグメンテーション、トラッキング
* MITKは入り口と出口のクラスだけ作って、あとはすべて自分で実装したほうが楽そう（セグメンテーションのプラグインクラスの解読をするのは前途多難）
* 実際のデータを入手して、大体の感触を掴んでみたい。ノイズが多ければかなりの難航が予想される
* 普通に閾値を設定するだけではノイズが入り込んでくる（断面によって、蛍光の明るさが変わってきたりする）。
* 空間的波長の長短などでのセグメンテーションも可能？(c.f. MITKのセグメンテーションにおけるピッキング)  
ノイズ処理については、画像処理ツール（NIS、ITK）の基本機能だと思うので、それをうまく使いましょう。


### 実際どうするか
* スライスの一枚目で手動でセルの場所、閾値を設定する
* 新たな細胞の出現・細胞がいなくなる、などの問題(？)  
→ 細胞がいなくなるのは、いなくなったものとしましょう。そこに予測とかを入れるのは、ひとまず僕らのやることではないとします。４次元空間上で連続なオブジェクトをひと塊にする、と言うことですが。
* トラッキングができていないことが判明したときに、逐次変更できるようにする必要がある。暫定的に保持していくような感じ？（otherwise、修正で発生したファイルが大量に残ることになる）
* すべてのスライスに対して行うのか、最初と最後のみ行うのか、10スライスごとに行うとか（細胞の量によって変わってくる）
* 全自動が理想だが・・・

上記のようにしてトラッキングしたデータから、点と線のデータに変換する必要がある。
時間スライスごとに表面だけ抽出したデータを微分幾何ライブラリに投げ、たくさんの球を出力させればよい。

![ホワイトボード写真](http://f.st-hatena.com/images/fotolife/k/kuyata/20151217/20151217205812.jpg "ホワイトボード写真")

```
それ以外の「オブジェクトの形と動き」の情報取り出しメニューとしては、以下のように考えています。

---------
# ラベリングしてボクセルのクラスタを作る
# 時系列ラベリングの場合には、空間的に全時刻で連結であることをもって
# 連結体(クラスタ)とみなす、などの制約を入れることも考慮するが
# 今は単純に全次元での連結とする

# クラスタごとに特徴量抽出をする
## 1 IDを振る
## 2 全体積
## 3 空間体積の時系列ベクトル
## 4 全表面積
## 5 空間表面積の時系列ベクトル
## 6 全重心座標
## 7 空間重心の時系列ベクトル
## 8 空間三角化メッシュの時系列
## 9 空間曲率分布の時系列(頂点空間曲率の頂点重み付き分布)
## 10 全トポロジー
## 11 空間トポロジーの時系列
## 12 全PCA分解
## 13 空間PCA分解の時系列
## 14 全PCA超楕球からの残差
## 15 空間PCA分解超楕球からの残差の時系列

# クラスターごとの抽出特徴量から「意味を与えた」解析項目を作る
## クラスターごとの「意味」
## 1 軌道 (速度・向き・それらの変化)
## 2 拡大縮小　体積の時系列変化
## 3 回転　空間PCA分解の時系列変化
## 4 形の変化　空間PCA分解超楕球からの残差の時系列変化
## 5 曲率の分布、曲率の空間微分の分布、さらにその微分の分布
## 6 曲率の時間微分については、2D空間＋1D時間の3Dにすることで、いわゆる3D画像の離散外積部分幾何(DEC)を使うことができる

## クラスター集合の分布に関する「意味」
## 1 情報量の多い視野という指標を作る
## 3 クラスターが作る分布の時系列変化
## 4 クラスターが作る分布の位置別比較


---
# 上記のうち、少しわかりにくいのは、立体形状全体をDEC扱いすることとその後の処理
# ３次元オブジェクトの形全体を扱う・その時間変化を扱うには、以下のようにする

Voxel x time = 4D data

3D x 1T とする

3Dごとに周縁をメッシュ化する

Fiaringアルゴリズムにて、正球にまで変形する

球面スカラー場とする

球面調和級数関数分解する

スペクトルの時間微分をとる

かたちの比較：スペクトル比較
動きの比較　：スペクトル時間微分の比較

-----

# 上記の処理の(ほぼ)すべては(かなり疎な)行列を使った線形代数処理と見える

全部が線形代数的なら、画像４次元アレイデータから、一気に、「知りたい特徴量」を算出するアルゴリズムができないか…
```
